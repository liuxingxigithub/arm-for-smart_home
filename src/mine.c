#include<stdio.h>
#include <stdlib.h>
#include <time.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/stat.h>
#include <linux/input.h>
#include"lcd.h"
#include"mine.h"
#include"bmp.h"


char* path_arrow = "../res/return.bmp";

int mine_num = 10;
int clicked_num = 0;
int margin_UD = 40;
int margin_LR = 200;
int m[mine_height + 2][mine_width + 2];     // 0未打开，1地雷，2已打开

// 颜色
int c_bg = 0xFFFFFF;
int c_number[8] = {0XFFFFFF,0X00FF00,0X0000FF,0XFFA500,0XFF69B4,0XFFFF00,0XFF0000,0X800080};
int c_unopen = 0xC0C0C0;
int c_open = 0xFFF5EE;
int c_win_bg = 0XFF0000;
int c_win_font = 0X00FF00;
int c_failed_bg = 0X0000F0;
int c_failed_font = 0X000000;


//数值1-8
int num_width = 16;
int num_height = 21;
int padding_UD = 6;
int padding_LR = 4; 

unsigned char mine_number[8][16*21/8] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x0E,0x00,0x1E,0x00,0x7E,0x00,0x7E,0x00,
0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,
0x0E,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x7F,0x80,0x7B,0xC0,0xE1,0xC0,0x41,0xC0,
0x03,0xC0,0x03,0x80,0x07,0x80,0x0F,0x00,0x0E,0x00,0x1C,0x00,0x38,0x00,0x78,0x00,
0xFF,0xC0,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x3F,0x80,0x73,0xC0,0xF1,0xC0,0x61,0xC0,
0x03,0x80,0x0F,0x80,0x1F,0x80,0x03,0xC0,0x01,0xC0,0x41,0xC0,0xE1,0xC0,0x73,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x07,0x80,0x07,0x80,0x0F,0x80,0x1F,0x80,
0x1F,0x80,0x3B,0x80,0x73,0x80,0x73,0x80,0xE3,0x80,0xFF,0xE0,0xFF,0xE0,0x03,0x80,
0x03,0x80,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x80,0x7F,0xC0,0x7F,0x80,0x70,0x00,0x70,0x00,
0x7F,0x00,0xFF,0x80,0xE3,0xC0,0x01,0xC0,0x01,0xC0,0x41,0xC0,0xE3,0xC0,0xF7,0x80,
0x7F,0x80,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x0F,0x00,0x0E,0x00,0x1C,0x00,0x3C,0x00,
0x3F,0x00,0x7F,0x80,0x7B,0xC0,0xF1,0xE0,0xE1,0xE0,0xE1,0xE0,0xF1,0xE0,0x73,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xC0,0xFF,0xC0,0x7F,0xC0,0x03,0xC0,0x03,0x80,
0x07,0x00,0x07,0x00,0x0F,0x00,0x0E,0x00,0x0E,0x00,0x1C,0x00,0x1C,0x00,0x1C,0x00,
0x3C,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x7F,0x80,0x73,0xC0,0xE1,0xC0,0xE1,0xC0,
0x73,0x80,0x7F,0x80,0x7F,0x80,0xF3,0xC0,0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0xF3,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

unsigned char mine_win_fonts[4][40*35/8] = {
/*--  文字:  你  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x82,0x00,0x00,0x00,0x03,
0x87,0x00,0x00,0x00,0x03,0x87,0x00,0x00,0x00,0x03,0x8F,0x00,0x00,0x00,0x03,0x8E,
0x00,0x00,0x00,0x07,0x8F,0xFF,0xFF,0x80,0x07,0x1F,0xFF,0xFF,0x80,0x07,0x1C,0x0E,
0x03,0xC0,0x07,0x1C,0x0E,0x03,0xC0,0x0F,0x3C,0x0E,0x03,0x80,0x0F,0x38,0x0E,0x03,
0x80,0x0F,0x70,0x0E,0x07,0x80,0x1F,0xF0,0x0E,0x07,0x00,0x1F,0x60,0x0E,0x00,0x00,
0x3F,0x03,0x8E,0x3C,0x00,0x3F,0x03,0x8E,0x1C,0x00,0x7F,0x07,0x0E,0x1C,0x00,0xFF,
0x07,0x0E,0x1E,0x00,0x6F,0x07,0x0E,0x0E,0x00,0x0F,0x0F,0x0E,0x0E,0x00,0x0F,0x0E,
0x0E,0x0F,0x00,0x0F,0x1E,0x0E,0x07,0x00,0x0F,0x1C,0x0E,0x07,0x00,0x0F,0x1C,0x0E,
0x07,0x80,0x0F,0x38,0x0E,0x03,0x80,0x0F,0x38,0x0E,0x03,0x80,0x0F,0x70,0x0E,0x03,
0x80,0x0F,0xF0,0x0E,0x03,0x80,0x0F,0xE0,0x0E,0x03,0xC0,0x0F,0x00,0x0E,0x01,0x80,
0x0F,0x03,0xFE,0x00,0x00,0x0F,0x01,0xFC,0x00,0x00,0x06,0x00,0x78,0x00,0x00},

/*--  文字:  赢  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,
0x01,0xC0,0x00,0x00,0x00,0x01,0xE0,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0x80,0x7F,0xFF,
0xFF,0xFF,0x80,0x07,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,
0xFE,0x00,0x03,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFC,
0x00,0x0F,0xFF,0xFF,0xFC,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,
0x0F,0xFF,0xFF,0xFC,0x00,0x07,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,
0xC7,0xF1,0xFC,0x00,0x3F,0xEF,0xFB,0xFE,0x00,0x38,0xFE,0x3F,0x9E,0x00,0x38,0xFD,
0xBF,0x8E,0x00,0x3F,0xFD,0xFF,0xEE,0x00,0x3F,0xFD,0xFF,0xFE,0x00,0x38,0xFD,0xFF,
0xFE,0x00,0x38,0xFD,0xFF,0xFE,0x00,0x3F,0xFF,0xFF,0xFF,0xC0,0x3F,0xFF,0xBF,0xFF,
0xC0,0x38,0xEF,0xF3,0xFF,0xC0,0x38,0xE7,0xF3,0xFF,0xC0,0x78,0xE7,0x7F,0xBF,0xC0,
0x70,0xEF,0x3F,0x0F,0xC0,0x77,0xFE,0x3F,0x0F,0xC0,0xF7,0xDC,0x0E,0x07,0x80},

/*--  文字:  了  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,
0xFF,0xFF,0xFC,0x00,0x1F,0xFF,0xFF,0xFF,0x00,0x0F,0xFF,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x1E,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x03,
0xE0,0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x7E,0x00,
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x01,0xE0,0x00,0x00,
0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0x00,
0x00,0x1C,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,
0x0F,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,
0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,
0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x78,0x3E,0x00,0x00,
0x00,0x7F,0xFC,0x00,0x00,0x00,0x3F,0xF0,0x00,0x00,0x00,0x07,0xC0,0x00,0x00},

/*--  文字:  ！  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,
0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,
0x00,0x01,0xF0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,
0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,
0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xE0,
0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,
0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

unsigned char mine_failed_fonts[4][40*35/8] = {
/*--  文字:  点  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,
0x03,0x80,0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x03,
0xFF,0xFF,0x80,0x00,0x03,0xFF,0xFF,0x80,0x00,0x03,0xFF,0xFF,0x00,0x00,0x03,0x80,
0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x07,0xFF,0xFF,0xF8,
0x00,0x0F,0xFF,0xFF,0xFC,0x00,0x0F,0xFF,0xFF,0xFC,0x00,0x0E,0x00,0x00,0x1C,0x00,
0x0E,0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0E,
0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0E,0x00,
0x00,0x1C,0x00,0x0F,0xFF,0xFF,0xFC,0x00,0x07,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,
0x00,0x00,0x07,0x1C,0x0E,0x1C,0x00,0x07,0x1E,0x0E,0x1E,0x00,0x0E,0x0E,0x0E,0x0F,
0x00,0x0E,0x0E,0x0F,0x07,0x00,0x1E,0x0E,0x07,0x07,0x80,0x1C,0x0E,0x07,0x03,0x80,
0x38,0x0E,0x07,0x03,0xC0,0x78,0x0E,0x07,0x01,0xC0,0x70,0x0E,0x03,0x01,0xC0},

/*--  文字:  到  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x3F,
0xFF,0xFC,0x03,0x80,0x7F,0xFF,0xFE,0x83,0x80,0x3F,0xFF,0xFF,0xC3,0x80,0x00,0xE0,
0x03,0xC3,0x80,0x01,0xE3,0x83,0xC3,0x80,0x01,0xC3,0x83,0xC3,0x80,0x03,0xC3,0xC3,
0xC3,0x80,0x03,0x81,0xC3,0xC3,0x80,0x07,0x81,0xE3,0xC3,0x80,0x07,0x00,0xE3,0xC3,
0x80,0x0E,0x1F,0xF3,0xC3,0x80,0x1F,0xFF,0xF3,0xC3,0x80,0x1F,0xFF,0x7B,0xC3,0x80,
0x00,0x38,0x3B,0xC3,0x80,0x00,0x38,0x3B,0xC3,0x80,0x00,0x38,0x03,0xC3,0x80,0x00,
0x38,0x03,0xC3,0x80,0x00,0x38,0x03,0xC3,0x80,0x00,0x38,0x03,0xC3,0x80,0x3F,0xFF,
0xFB,0xC3,0x80,0x3F,0xFF,0xFB,0xC3,0x80,0x00,0x38,0x03,0xC3,0x80,0x00,0x38,0x03,
0xC3,0x80,0x00,0x38,0x03,0xC3,0x80,0x00,0x38,0x01,0xC3,0x80,0x00,0x38,0x00,0x03,
0x80,0x00,0x38,0x00,0x03,0x80,0x00,0x38,0x1C,0x03,0x80,0x00,0x3F,0xFE,0x03,0x80,
0x3F,0xFF,0xFC,0xF7,0x80,0xFF,0xFC,0x00,0xFF,0x80,0x78,0x00,0x00,0x7F,0x00},

/*--  文字:  雷  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,
0xFF,0xFF,0xFE,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,
0xE0,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0x80,0x7F,0xFF,0xFF,0xFF,0xC0,0x70,0x00,0xE0,
0x01,0xC0,0x70,0x00,0xE0,0x01,0xC0,0x7F,0xFE,0xFF,0xFD,0xC0,0x7F,0xFE,0xFF,0xFF,
0xC0,0x70,0x00,0xE0,0x03,0x80,0x70,0x00,0xE0,0x07,0x80,0x70,0x00,0xE0,0x03,0x00,
0x0F,0xFF,0xFF,0xFE,0x00,0x0F,0xFF,0xFF,0xFE,0x00,0x00,0x00,0xE0,0x00,0x00,0x03,
0xFF,0xFF,0xF0,0x00,0x0F,0xFF,0xFF,0xFE,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x1C,0x00,
0xE0,0x0E,0x00,0x1C,0x00,0xE0,0x0E,0x00,0x1C,0x00,0xE0,0x0E,0x00,0x1F,0xFF,0xFF,
0xFE,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x1C,0x00,0xE0,0x0E,
0x00,0x1C,0x00,0xE0,0x0E,0x00,0x1C,0x00,0xE0,0x0E,0x00,0x1C,0x00,0xE0,0x0E,0x00,
0x1F,0xFF,0xFF,0xFE,0x00,0x0F,0xFF,0xFF,0xFE,0x00,0x06,0x00,0x00,0x10,0x00},

/*--  文字:  了  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,
0xFF,0xFF,0xFC,0x00,0x1F,0xFF,0xFF,0xFF,0x00,0x0F,0xFF,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x1E,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x03,
0xE0,0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x7E,0x00,
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x01,0xE0,0x00,0x00,
0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0x00,
0x00,0x1C,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,
0x0F,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,
0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x07,0x00,
0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x78,0x3E,0x00,0x00,
0x00,0x7F,0xFC,0x00,0x00,0x00,0x3F,0xF0,0x00,0x00,0x00,0x07,0xC0,0x00,0x00}
};



void mine_draw_gezi(int mx, int my, int color)
{
    printf("gezi1\n");
    printf("mx: %d my: %d\n", mx, my);
    int x = (mx-1)*per_len + margin_LR;
    int y = (my-1)*per_len + margin_UD; 
    printf("x: %d y: %d\n", x, y);
    lcd_draw_clear(x, y, x + per_len - 2, y + per_len - 2, color);
}

void mine_draw_font(int mx, int my, int number)
{
    int x = (mx-1)*per_len + margin_LR + padding_LR;
    int y = (my-1)*per_len + margin_UD + padding_UD;
    printf("%d %d\n", x, y);
    lcd_draw_one_word(x, y, c_number[number - 1], num_width, num_height, mine_number[number - 1]);
}

// 初始化扫雷区域
void mine_init() 
{
    clicked_num = 0;
    lcd_draw_clear(0, 0, 800, 480, c_bg);
    srand((unsigned) time(NULL)); // 根据当前时间设置随机数种子
    int i, j;
    int count = 0; // 已放置的地雷数量
    // 先将所有位置初始化为0
    for (i = 0; i < mine_height + 2; ++i) 
    {
        for (j = 0; j < mine_width + 2; ++j) 
        {
            m[i][j] = 0;
            if(i!=0 && j!=0 && i!=mine_height+1 && j!=mine_width+1)
            {
                mine_draw_gezi(i, j, c_unopen);
            }
            else
            {
                m[i][j] = 2;
            }
        }
    }
    // 随机放置地雷
    while (count < mine_num) {
        i = rand() % mine_height + 1;
        j = rand() % mine_width + 1;
        if (m[i][j] == 0) 
        {
            m[i][j] = 1; // 标记该位置为地雷
            count++;     // 已放置的地雷数量加1
        }
    }
}

// 计算指定位置周围地雷数量
int mine_count_around(int mx, int my) 
{
    int count = 0;
    int i, j;
    for (i = mx - 1; i <= mx + 1; ++i) {
        for (j = my - 1; j <= my + 1; ++j) {
            if (m[i][j] == 1) 
            {
                count++;
            }
        }
    }
    return count;
}

// 翻开指定位置
void mine_click(int mx, int my) 
{
    printf("mine1\n");
    if (m[mx][my] == 1) { // 如果该位置是地雷，则游戏结束
        mine_failed();
        return;
    }

    printf("mine2\n");
    if (m[mx][my] == 2) { // 如果该位置已经翻开，则直接返回
        return;
    }

    printf("mine3\n");
    m[mx][my] = 2; // 标记该位置为已翻开
    clicked_num ++;
    mine_draw_gezi(mx, my, c_open); // 绘制已经翻开的方块
    printf("mine4\n");
    int n = mine_count_around(mx, my);
    if (n == 0) { // 如果周围没有地雷，则递归翻开周围的位置
        int i, j;
        for (i = mx - 1; i <= mx + 1; ++i) {
            for (j = my - 1; j <= my + 1; ++j) {
                printf("i: %d, j: %d", i, j);
                mine_click(i, j);
            }
        }
    }
    else
    {
        printf("mine5\n");
        mine_draw_font(mx, my, n);
    }
}


// 处理玩家点击事件
void player_click(int x, int y) 
{
    int mx = (x - margin_LR) / per_len + 1;
    int my = (y - margin_UD) / per_len + 1;
    
    if ((mx < 1) || (mx > 8) || (my < 1) || (my > 8)) { // 如果输入的位置不合法
        return;
    }

    if (m[mx][my] == 2) { // 如果选择了已经翻开的位置
        return;
    }

    mine_click(mx, my); // 翻开该位置5
    
    if (clicked_num == mine_width * mine_height - mine_num) { // 如果所有非地雷位置都已翻开，则游戏胜利
        mine_win();
    }
}

// 游戏成功
void mine_win() 
{
    lcd_draw_clear(610, 50, 790, 250, c_win_bg);
    lcd_draw_word(620, 137, c_win_font, 4, 40, 35, mine_win_fonts);
    printf("游戏成功！\n");
}

// 游戏失败
void mine_failed() 
{
    lcd_draw_clear(610, 50, 790, 250, c_failed_bg);
    lcd_draw_word(620, 137, c_failed_font, 4, 40, 35, mine_failed_fonts);
    printf("游戏失败！\n");
}

void mine_start()
{
    mine_init();

    /*图片的信息*/
    unsigned char* data;
    int width;
    int height;
    int pix_bit;
    
    int bmpfd = bmp_open_file(path_arrow);
    bmp_get_pic_message(bmpfd, &data, &width, &height, &pix_bit);
    bmp_colse_file(bmpfd);
    // 绘制箭头
    showPic_append(data, height, width, pix_bit);

    int event_fd = 0;
	ssize_t rsize = 0;
	struct input_event ev;//用来保存从输入设备中获取到的的输入事件
	event_fd =open("/dev/input/event0",O_RDWR);
	if (-1 == event_fd)
	{
		perror("open event0 error");
	}
	
    int xi = 0, x_down = 0;
    int yi = 0, y_down = 0;
	while(1)
	{
		rsize = read(event_fd, &ev, sizeof(ev));
		if (rsize == sizeof(ev))    //读到了输入事件
		{
            //printf("0x%2x 0x%2x %d\n", ev.type, ev.code, ev.value);
            if (ev.type == 0X03)
            {
                // 1022*600
                if (ev.code == 0X00)
                {
                    //printf("x: %d   %d\n", ev.value, ev.value*8/12);
                    xi = ev.value * 800 / 1020;              
                }
                else if (ev.code == 0X01)
                {   
                    //printf("y: %d   %d\n", ev.value, ev.value*8/12);
                    yi = ev.value * 480 / 600;
                }
            }
            if (ev.code == 0x14a)
            {
                if (ev.value == 1)
                {
                    x_down = xi;
                    y_down = yi;
                }
                else if (ev.value == 0)
                {
                    printf("xi: %d x_down: %d yi: %d y_down: %d\n", xi, x_down, yi, y_down);
                    if (xi < 80 && yi < 60)
                    {
                        break;
                    }
                    if ((xi > x_down - 5) && (xi < x_down + 5) && (yi > y_down - 5) && (yi < y_down +5))
                    {
                        player_click(xi, yi);
                    }
                }
                
            }
        }
	}
    free(data);
}