#include"lcd.h"
#include"bmp.h"
#include"GY-39.h"
#include"pwm.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <termios.h>
#include <pthread.h>
#include <linux/input.h>
#include <sys/types.h>
#include <sys/stat.h>


char* bg_path = "../res/message.bmp";   // 背景图片
int data_x1 = 150, data_x2 = 550;     // 数据两列的起始x
int data_y1 = 80, data_y2 = 240, data_y3 = 420;    // 数据三行的起始坐标
int number_width = 16, number_height = 21;
int is_return = 0;

//数值0-9
unsigned char number[10][16*21/8] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x3F,0x80,0x7B,0x80,0x73,0xC0,0xF1,0xC0,
0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0x73,0xC0,0x7B,0x80,
0x3F,0x80,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x0E,0x00,0x1E,0x00,0x7E,0x00,0x7E,0x00,
0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,
0x0E,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x7F,0x80,0x7B,0xC0,0xE1,0xC0,0x41,0xC0,
0x03,0xC0,0x03,0x80,0x07,0x80,0x0F,0x00,0x0E,0x00,0x1C,0x00,0x38,0x00,0x78,0x00,
0xFF,0xC0,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x3F,0x80,0x73,0xC0,0xF1,0xC0,0x61,0xC0,
0x03,0x80,0x0F,0x80,0x1F,0x80,0x03,0xC0,0x01,0xC0,0x41,0xC0,0xE1,0xC0,0x73,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x07,0x80,0x07,0x80,0x0F,0x80,0x1F,0x80,
0x1F,0x80,0x3B,0x80,0x73,0x80,0x73,0x80,0xE3,0x80,0xFF,0xE0,0xFF,0xE0,0x03,0x80,
0x03,0x80,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x80,0x7F,0xC0,0x7F,0x80,0x70,0x00,0x70,0x00,
0x7F,0x00,0xFF,0x80,0xE3,0xC0,0x01,0xC0,0x01,0xC0,0x41,0xC0,0xE3,0xC0,0xF7,0x80,
0x7F,0x80,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x0F,0x00,0x0E,0x00,0x1C,0x00,0x3C,0x00,
0x3F,0x00,0x7F,0x80,0x7B,0xC0,0xF1,0xE0,0xE1,0xE0,0xE1,0xE0,0xF1,0xE0,0x73,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xC0,0xFF,0xC0,0x7F,0xC0,0x03,0xC0,0x03,0x80,
0x07,0x00,0x07,0x00,0x0F,0x00,0x0E,0x00,0x0E,0x00,0x1C,0x00,0x1C,0x00,0x1C,0x00,
0x3C,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x7F,0x80,0x73,0xC0,0xE1,0xC0,0xE1,0xC0,
0x73,0x80,0x7F,0x80,0x7F,0x80,0xF3,0xC0,0xE1,0xC0,0xE1,0xC0,0xE1,0xC0,0xF3,0xC0,
0x7F,0x80,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x7F,0x80,0xF7,0xC0,0xE3,0xC0,0xE1,0xC0,
0xE1,0xC0,0xE3,0xC0,0xF7,0x80,0x7F,0x80,0x1F,0x00,0x0F,0x00,0x0E,0x00,0x1E,0x00,
0x1C,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

unsigned char warnModel[5][40*35/8] = {
    /*--  文字:  温  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,
0x0F,0xFF,0xF8,0x00,0x3C,0x1F,0xFF,0xFC,0x00,0x1E,0x3F,0xFF,0xFE,0x00,0x0F,0x38,
0x00,0x0E,0x00,0x07,0xB8,0x00,0x0E,0x00,0x03,0xF8,0x00,0x0E,0x00,0x01,0xFF,0xFF,
0xFE,0x00,0x00,0xFF,0xFF,0xFE,0x00,0xF0,0x3F,0xFF,0xFE,0x00,0xF8,0x38,0x00,0x0E,
0x00,0x7C,0x38,0x00,0x0E,0x00,0x1E,0x38,0x00,0x0E,0x00,0x0F,0x3F,0xFF,0xFE,0x00,
0x07,0x9F,0xFF,0xFE,0x00,0x03,0x8F,0xFF,0xFC,0x00,0x01,0x80,0x00,0x00,0x00,0x01,
0x80,0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x03,0xBF,0xFF,0xFE,0x00,0x03,0xFF,
0xFF,0xFF,0x00,0x07,0x70,0xE3,0x87,0x00,0x07,0x70,0xE3,0x87,0x00,0x07,0x70,0xE3,
0x87,0x00,0x0F,0x70,0xE3,0x87,0x00,0x0E,0x70,0xE3,0x87,0x00,0x0E,0x70,0xE3,0x87,
0x00,0x1C,0x70,0xE3,0x87,0x00,0x1C,0x70,0xE3,0x87,0x00,0x3C,0x70,0xE3,0x87,0x00,
0x38,0xFF,0xFF,0xFF,0x80,0x71,0xFF,0xFF,0xFF,0xE0,0x71,0xFF,0xFF,0xFF,0xC0},

/*--  文字:  度  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,
0x01,0xE0,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0x80,0x1F,0xFF,
0xFF,0xFF,0x80,0x1E,0x18,0x00,0xC0,0x00,0x1C,0x1C,0x01,0xC0,0x00,0x1C,0x1C,0x01,
0xC0,0x00,0x1C,0x1C,0x01,0xC0,0x00,0x1F,0xFF,0xFF,0xFF,0x00,0x1F,0xFF,0xFF,0xFF,
0x80,0x1C,0x1C,0x01,0xC0,0x00,0x1C,0x1C,0x01,0xC0,0x00,0x1C,0x1C,0x01,0xC0,0x00,
0x1C,0x1F,0xFF,0xC0,0x00,0x1C,0x1F,0xFF,0xC0,0x00,0x1C,0x0F,0xFF,0x80,0x00,0x1C,
0x00,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,0x00,0x1D,0xFF,0xFF,0xFC,0x00,0x1D,0xFF,
0xFF,0xFC,0x00,0x1C,0x38,0x00,0x3C,0x00,0x1C,0x3C,0x00,0xF8,0x00,0x1C,0x1E,0x01,
0xF0,0x00,0x3C,0x0F,0x87,0xC0,0x00,0x38,0x07,0xDF,0x80,0x00,0x38,0x03,0xFF,0x00,
0x00,0x38,0x01,0xFC,0x00,0x00,0x38,0x07,0xFE,0x00,0x00,0x78,0x3F,0x9F,0xC0,0x00,
0x77,0xFE,0x07,0xFC,0x00,0xFF,0xF0,0x00,0xFF,0xC0,0xEF,0x00,0x00,0x0F,0xC0},

/*--  文字:  过  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,
0x00,0x00,0x1C,0x00,0x0E,0x00,0x00,0x1C,0x00,0x0F,0x00,0x00,0x1C,0x00,0x07,0x00,
0x00,0x1C,0x00,0x07,0x9F,0xFF,0xFF,0xC0,0x03,0x9F,0xFF,0xFF,0xC0,0x03,0xCF,0xFF,
0xFF,0x80,0x01,0xC0,0x00,0x1C,0x00,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,0x00,0x1C,
0x00,0x00,0x03,0x80,0x1C,0x00,0x7E,0x03,0xC0,0x1C,0x00,0x7F,0x81,0xE0,0x1C,0x00,
0x7F,0x80,0xE0,0x1C,0x00,0x03,0x80,0xF0,0x1C,0x00,0x03,0x80,0x78,0x1C,0x00,0x03,
0x80,0x38,0x1C,0x00,0x03,0x80,0x1C,0x1C,0x00,0x03,0x80,0x1E,0x1C,0x00,0x03,0x80,
0x0E,0x1C,0x00,0x03,0x80,0x04,0x1C,0x00,0x03,0x80,0x00,0x1C,0x00,0x03,0x80,0x00,
0x1C,0x00,0x03,0x80,0x00,0x1C,0x00,0x03,0xC0,0x00,0x1C,0x00,0x03,0xC0,0x3E,0x3C,
0x00,0x07,0xE0,0x1F,0xF8,0x00,0x0F,0xF8,0x07,0xF0,0x00,0x3E,0x7E,0x00,0x00,0x00,
0x7C,0x1F,0xFF,0xFF,0xC0,0x78,0x07,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00},

/*--  文字:  高  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,
0x01,0xC0,0x00,0x00,0x00,0x01,0xE0,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x7F,0xFF,
0xFF,0xFF,0xC0,0x7F,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,
0xC0,0x00,0x01,0xFF,0xFF,0xF0,0x00,0x01,0xFF,0xFF,0xF0,0x00,0x01,0xC0,0x00,0x70,
0x00,0x01,0xC0,0x00,0x70,0x00,0x01,0xC0,0x00,0x70,0x00,0x01,0xFF,0xFF,0xF0,0x00,
0x01,0xFF,0xFF,0xF0,0x00,0x00,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
0xFF,0xFF,0xFC,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x1F,0xFF,0xFF,0xFF,0x00,0x1C,0x00,
0x00,0x07,0x00,0x1C,0x3F,0xFF,0x87,0x00,0x1C,0x7F,0xFF,0xC7,0x00,0x1C,0x78,0x03,
0xC7,0x00,0x1C,0x70,0x01,0xC7,0x00,0x1C,0x70,0x01,0xC7,0x00,0x1C,0x70,0x01,0xC7,
0x00,0x1C,0x70,0x01,0xC7,0x00,0x1C,0x7F,0xFF,0xC7,0x00,0x1C,0x3F,0xFF,0xC7,0x00,
0x1C,0x1F,0xFF,0x47,0x00,0x1C,0x00,0x00,0xFF,0x00,0x1C,0x00,0x00,0xFE,0x00},

/*--  文字:  ！  --*/
/*--  幼圆26;  此字体下对应的点阵为：宽x高=36x35   --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=40x35  --*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,
0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,
0x00,0x01,0xF0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,
0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,
0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xE0,
0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,
0x00,0x01,0xF8,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

// 获得数字的字模数组
void getWordIndex(int num, int* len, int** words_p)
{
    int a[10];
    int i = 0;
    while (num)
    {
        if (i == 10){
            perror("获得数字的字模数组时缓存数组长度不足");
        }
        a[i] = num % 10;
        num /= 10;
        i++;
    }
    *words_p = (unsigned int*)malloc(sizeof(int*)*i);
    for(int j = 0; j < i; j++)
    {
        (*words_p)[j] = a[i-1-j];
    }
    *len = i;
}



// 绘制数据
void showData(float temperature, float humidity, float pressure, float altitude, float illuminance)
{
    float data[5] = {pressure, temperature, humidity, altitude, illuminance};
    // 5个数据的显示位置
    int x[5] = {data_x1, data_x2, data_x1, data_x2, data_x1};
    int y[5] = {data_y1, data_y1, data_y2, data_y2, data_y3};
    int color = 0X000000;
    int* words_index = {0};
    int len = 0;
    for (int i = 0; i < 5; i++)
    {
        getWordIndex((int)data[i], &len, &words_index);
        lcd_draw_clear(x[i], y[i], x[i] + 8 * number_width, y[i] + number_height, 0XFFFFFF);
        for (int j = 0; j < len; j++)
        {
            printf("%d ,", words_index[j]);
            lcd_draw_one_word(x[i] + number_width * j, y[i], color, number_width, number_height, number[words_index[j]]);
        }
        printf("\n");
    }
}

void showWarn()
{
    int red = 0XFF0000;
    int yellow = 0XFFFF00;
    lcd_draw_clear(400, 350, 800, 480, red);
    lcd_draw_word(data_x2 - 50, data_y3, yellow, 5, 40, 35, warnModel);
}

void* check_return(void *args)
{
    int event_fd = 0;
	ssize_t rsize = 0;
	struct input_event ev;  //用来保存从输入设备中获取到的的输入事件
	event_fd =open("/dev/input/event0",O_RDWR);
	if (-1 == event_fd)
	{
		perror("open event0 error");
	}
	
    int xi = 0, yi = 0;
	while(1)
	{
		rsize = read(event_fd, &ev, sizeof(ev));
		if (rsize == sizeof(ev))//读到了输入事件
		{
            if (ev.type == 0X03)
            {
                if (ev.code == 0X00)
                {
                    xi = ev.value;                
                }
                else if (ev.code == 0x01)
                {
                    yi = ev.value;
                }
            }

            if ((ev.code == 0x14a) && (ev.value == 0))
            {
                if ((xi < 80) && (yi < 60))
                {
                    is_return = 1;
                    break;
                }
                
            }
        }
    }
}

int warner_start()
{
    is_return = 0;
    // 画个背景
    unsigned char* data;
    int width;
    int height;
    int pix_bit;
    int bmpfd = bmp_open_file(bg_path);
    bmp_get_pic_message(bmpfd, &data, &width, &height, &pix_bit);
    bmp_colse_file(bmpfd);
    showPic_write(data, height, width, pix_bit);
    free(data);

    //画个返回箭头
    bmpfd = bmp_open_file("../res/return.bmp");
    bmp_get_pic_message(bmpfd, &data, &width, &height, &pix_bit);
    bmp_colse_file(bmpfd);
    showPic_append(data, height, width, pix_bit);
    free(data);

    // 
    float temperature, humidity, pressure, altitude, illuminance;


    // 开启返回按钮监听
    pthread_t pid;
    int ret = 0;
    ret = pthread_create(&pid, NULL, check_return, NULL);
    if (ret != 0)
    {
        printf("check return create error!\n");;
    }

    // 持续更新数据
    while (1)
    {
        if (is_return == 1)
        {
            return 0;
        }
        
        // 获取气象数据
        if(gy39_get_weather(&temperature, &humidity, &pressure, &altitude) == 0)
        {
            printf("Temperature: %.2f C\n", temperature);
            printf("Humidity: %.2f %%RH\n", humidity);
            printf("Pressure: %.2f hPa\n", pressure);
        }
        else
        {
            printf("Failed to get weather data!\n");
        }

        // 获取光照强度数据
        if(gy39_get_light(&illuminance) == 0)
        {
            printf("Illuminance: %.2f lx\n", illuminance);
        }
        else
        {
            printf("Failed to get light data!\n");
        }

        if (temperature > 30)
        {
            showWarn();
            pwm_start();
        }
        else
        {
            lcd_draw_clear(400, 350, 800, 480, 0XFFFFFF);
            pwm_stop();
        }

        // 将数据显示到屏幕
        showData(temperature, humidity, pressure, altitude, illuminance);
    }

    return 0;
}